#!/usr/bin/env python3
q='.txt'
p=RuntimeError
o=Exception
n=ValueError
j=False
i='<I'
h='wb'
g='r+b'
d='size'
c='ascii'
b='NATRIUM'
a=sorted
Z=int
Y='cp437'
X=bytearray
W=bytes
V=FileNotFoundError
T='attr'
S='start_block'
R=len
N=True
M='num_blocks'
L='<H'
K=range
J=open
H=b'\x00'
F=None
E='name'
C=print
import os as B,struct as G,argparse as r,math
A=1024
D=4
k=8
U=127
s=0
t=1
O=128
l=17
P=0
Q=16
e=18
f=19
I=20
m={q,'.ans','.nfo','.cfg','.ini','.bat','.cmd','.md','.asm','.c','.h','.cpp','.py','.json','.xml','.csv','.log'}
class u:
	def __init__(A,path):A.path=path;A.disk=F
	def open(A,mode=g):
		if not B.path.exists(A.path)and'w'not in mode:raise V(A.path)
		A.disk=J(A.path,mode)
	def close(A):
		if A.disk:A.disk.flush();A.disk.close();A.disk=F
	def _read_next_free_block(B):B.disk.seek(A+l);return G.unpack(L,B.disk.read(2))[0]
	def _write_next_free_block(B,block_num):B.disk.seek(A+l);B.disk.write(G.pack(L,block_num))
	def create(E,size_kb,volume_name=b):
		F=size_kb*1024
		with J(E.path,h)as B:
			B.write(H*A);I=volume_name.ljust(16).encode(c)[:16];B.write(I);B.write(b'\x01');B.write(G.pack(L,6));B.write(H*(A-19));B.write(W([U]));B.write(H*31);B.write(H*(A*D-32));C=F-B.tell()
			if C<0:raise n('Disk size too small for filesystem structures')
			B.write(H*C)
	def _read_block(B,block_num,size=A):B.disk.seek(block_num*A);return B.disk.read(size)
	def _write_block(B,block_num,data):
		if R(data)>A:raise n('Data exceeds block size')
		B.disk.seek(block_num*A);B.disk.write(data.ljust(A,H))
	def _read_dir_buffer(B,start_block,num_blocks):C=min(num_blocks,k);return B._read_block(start_block,C*A)
	def _write_dir_buffer(C,start_block,buf,blocks=D):
		for B in K(blocks):D=buf[B*A:(B+1)*A];C._write_block(start_block+B,D)
	def _parse_dir_buffer(Z,buf):
		F=[]
		for O in K(U):
			D=32+O*32
			if D+32>R(buf):break
			B=buf[D:D+32]
			if B[0]==0:continue
			V=B[P:P+16].decode(c,errors='ignore').rstrip();W,=G.unpack(L,B[Q:Q+2]);H=B[e];X=B[f];Y=G.unpack(i,B[I:I+4])[0];J=G.unpack(L,B[I:I+2])[0];C=Y
			if C==0 and J!=0:
				try:
					N=H*A-J
					if N>=0:C=N
				except o:C=0
			F.append({E:V,S:W,M:H,T:X,d:C})
		return F
	def list_dir(B,start_block=2):C=B._read_block(start_block,A*D);return B._parse_dir_buffer(C)
	def find_dir_by_name(B,name):
		for A in B.list_dir(2):
			if A[E]==name and A[T]&O:return A[S]
	def mkdir(C,name):
		N=X(C._read_block(2,A*D));J=F
		for E in K(U):
			R=32+E*32
			if N[R]==0:J=R;break
		if J is F:raise p('No free directory entries in root')
		M=C._read_next_free_block();C._write_next_free_block(M+D);S=W([U])+H*31;S+=H*(A*D-32)
		for E in K(D):C._write_block(M+E,S[E*A:(E+1)*A])
		B=X(32);B[P:P+16]=name.ljust(16).encode(c)[:16];B[Q:Q+2]=G.pack(L,M);B[e]=D;B[f]=O;B[I:I+4]=G.pack(i,0);B[24:32]=H*8;N[J:J+32]=W(B);C._write_dir_buffer(2,N);return M
	def add_file(D,file_path,target_name=F,parent_block=2,system=j):
		C=file_path;A=target_name
		if A is F:A=B.path.basename(C)
		with J(C,'rb')as E:G=E.read()
		return D.add_file_bytes(A,G,parent_block,system)
	def add_file_bytes(C,target_name,data_bytes,parent_block=2,system=j):
		T=parent_block;S=data_bytes;V=R(S);E=(V+A-1)//A
		if E==0:E=1
		O=X(C._read_block(T,A*D));M=F
		for J in K(U):
			Y=32+J*32
			if O[Y]==0:M=Y;break
		if M is F:raise p('No free directory entries in target directory')
		N=C._read_next_free_block();C._write_next_free_block(N+E)
		for J in K(E):Z=S[J*A:(J+1)*A];C._write_block(N+J,Z)
		B=X(32);B[P:P+16]=target_name.ljust(16).encode(c)[:16];B[Q:Q+2]=G.pack(L,N);B[e]=E;B[f]=s|(t if system else 0);B[I:I+4]=G.pack(i,V);B[24:32]=H*8;O[M:M+32]=W(B);C._write_dir_buffer(T,O);return N
	def read_file(G,file_name,out_path=F,parent_block=2):
		I=file_name;H=out_path;Q=G._read_block(parent_block,A*D);R=G._parse_dir_buffer(Q)
		for C in R:
			if C[E]==I and C[T]&O==0:
				F=X()
				for U in K(C[M]):F.extend(G._read_block(C[S]+U))
				L=Z(C.get(d,0)or 0)
				if L<=0:P=C[M]*A
				else:P=L
				F=W(F[:P])
				if H:
					B.makedirs(B.path.dirname(H),exist_ok=N)
					with J(H,h)as Y:Y.write(F)
				return F
		raise V(I)
	def extract_all(F,output_dir,parent_block=2,rel_path=''):
		H=rel_path;G=output_dir;I=B.path.join(G,H);B.makedirs(I,exist_ok=N);J=F._read_block(parent_block,A*D);K=F._parse_dir_buffer(J)
		for C in K:
			if C[T]&O:L=B.path.join(H,C[E]);P=min(C[M],k);F._extract_dir_to_host(G,C[S],L,P)
			else:F._write_file_and_decode(C,G,H)
	def _extract_dir_to_host(D,output_dir,dir_start_block,rel_path,read_blocks):
		H=output_dir;F=rel_path;I=B.path.join(H,F);B.makedirs(I,exist_ok=N);J=D._read_block(dir_start_block,A*read_blocks);K=D._parse_dir_buffer(J)
		for G in K:
			if G[T]&O:C(f"[SKIP-DEEP] {B.path.join(F,G[E])} (nested dirs not supported)");continue
			D._write_file_and_decode(G,H,F)
	def _write_file_and_decode(P,e,output_dir,rel_path):
		G=output_dir;F=rel_path;H=B.path.join(G,F,e[E]);D=b''.join(P._read_block(e[S]+A)for A in K(e[M]));I=Z(e.get(d,0)or 0)
		if I<=0:L=e[M]*A
		else:L=I
		D=D[:L];B.makedirs(B.path.dirname(H),exist_ok=N)
		with J(H,h)as Q:Q.write(D)
		C(f"[FILE] {B.path.join(F,e[E])} ({R(D)} bytes)")
		if e[E].lower().endswith(q):
			try:
				T=D.decode(Y);O=B.path.join(G,F,f"{e[E]}.decoded.txt")
				with J(O,'w',encoding='utf-8')as U:U.write(T)
				C(f"[DECODED] {O}")
			except o as V:C(f"[DECODE-ERROR] {e[E]}: {V}")
	def pack_from_folder(H,source_dir,size_kb=F,volume_name=b):
		W=size_kb;V='replace';U=source_dir
		if not B.path.isdir(U):raise NotADirectoryError(U)
		def h(name):
			F='.sys.';A=name;B=A.lower();C=j
			if B.endswith('.sys'):C=N;D=A
			elif F in B:C=N;E=B.rindex(F);D=A[:E]+A[E+4:]
			else:D=A
			return D[:16],C
		X=[];P={}
		for Z in a(B.listdir(U)):
			Q=B.path.join(U,Z)
			if B.path.isfile(Q):X.append((Z,Q))
			elif B.path.isdir(Q):
				M=[]
				for O in a(B.listdir(Q)):
					E=B.path.join(Q,O)
					if B.path.isfile(E):M.append((O,E))
				P[Z]=M
		if W is F:
			S=A*(2+D);S+=R(P)*(A*D)
			for(G,E)in X:b=B.path.getsize(E);c=max(1,(b+A-1)//A);S+=c*A
			for(K,M)in P.items():
				for(G,E)in M:b=B.path.getsize(E);c=max(1,(b+A-1)//A);S+=c*A
			S+=A*10;W=math.ceil(S/1024)
		H.create(W,volume_name);H.open(g)
		try:
			i={}
			for K in a(P.keys()):l=K[:16];I=H.mkdir(l);i[K]=I;C(f"[MKDIR] {K} -> block {I}")
			for(G,E)in X:
				T,L=h(G);d=B.path.splitext(G)[1].lower()
				if d in m:
					with J(E,'r',encoding=Y,errors=V)as O:e=O.read()
					f=e.encode(Y,errors=V);I=H.add_file_bytes(T,f,parent_block=2,system=L)
				else:I=H.add_file(E,T,parent_block=2,system=L)
				C(f"[ADD] root: {G} -> block {I} (system={L})")
			for(K,M)in a(P.items()):
				k=i[K]
				for(G,E)in M:
					T,L=h(G);d=B.path.splitext(G)[1].lower()
					if d in m:
						with J(E,'r',encoding=Y,errors=V)as O:e=O.read()
						f=e.encode(Y,errors=V);I=H.add_file_bytes(T,f,parent_block=k,system=L)
					else:I=H.add_file(E,T,parent_block=k,system=L)
					C(f"[ADD] {K}/{G} -> block {I} (system={L})")
		finally:H.close()
def v():
	i='pack';h='extractall';f='read';e='list';c='mkdir';a='file';Y='add';X='--volume';W='create';Q='--dir';K=r.ArgumentParser(description='NatriumFS v1 utility');K.add_argument('disk',help='Path to NatriumFS disk image');H=K.add_subparsers(dest='command',required=N);U=H.add_parser(W,help='Create a new NatriumFS disk image');U.add_argument('size_kb',type=Z,help='Disk size in KB');U.add_argument(X,default=b,help='Volume name');J=H.add_parser(Y,help='Add file to disk');J.add_argument(a,help='Host file to add');J.add_argument('--name',help='Target filename on disk');J.add_argument(Q,help='Target subdirectory name (optional)');J.add_argument('--sys',help='Sets the file to have the System attribute',action='store_true');j=H.add_parser(c,help='Create a subdirectory in root');j.add_argument(E,help='Subdirectory name');k=H.add_parser(e,help='List files in root or subdirectory');k.add_argument(Q,help='Subdirectory to list (optional)');L=H.add_parser(f,help='Read a file from disk');L.add_argument(a,help='Filename on disk');L.add_argument('--out',help='Output path on host (optional)');L.add_argument(Q,help='Subdirectory to read from (optional)');l=H.add_parser(h,help='Extract entire disk to host');l.add_argument('outdir',help='Destination directory on host');P=H.add_parser(i,help='Pack a folder into a NatriumFS disk image');P.add_argument('source',help='Source folder to pack (top-level files + one-level subdirs)');P.add_argument('--size-kb',type=Z,help='Optional disk size in KB. If omitted, auto-calculated.');P.add_argument(X,default=b,help='Volume name for created image');A=K.parse_args();D=u(A.disk)
	if A.command==W:D.create(A.size_kb,A.volume);C(f"Created NatriumFS {A.size_kb}KB disk: {A.disk}");return
	if A.command==i:D.pack_from_folder(A.source,size_kb=A.size_kb,volume_name=A.volume);C(f"Packed folder '{A.source}' into disk image '{A.disk}' (size_kb={A.size_kb or"auto"})");return
	D.open(g)
	try:
		if A.command==c:F=D.mkdir(A.name);C(f"Created subdirectory '{A.name}' at block {F}")
		elif A.command==Y:
			G=2
			if A.dir:
				F=D.find_dir_by_name(A.dir)
				if not F:raise V(f"Subdirectory '{A.dir}' not found")
				G=F
			m=D.add_file(A.file,A.name,G,A.sys);C(f"Added '{A.file}' as '{A.name or B.path.basename(A.file)}' at block {m}")
		elif A.command==e:
			G=2
			if A.dir:
				F=D.find_dir_by_name(A.dir)
				if not F:raise V(f"Subdirectory '{A.dir}' not found")
				G=F
			n=D.list_dir(G)
			for I in n:o='DIR'if I[T]&O else'FILE';C(f"{I[E]:16} {o} blocks={I[M]} start={I[S]} size={I.get(d,0)}")
		elif A.command==f:
			G=2
			if A.dir:
				F=D.find_dir_by_name(A.dir)
				if not F:raise V(f"Subdirectory '{A.dir}' not found")
				G=F
			p=D.read_file(A.file,A.out,parent_block=G)
			if not A.out:C(f"Read {R(p)} bytes from '{A.file}'")
		elif A.command==h:D.extract_all(A.outdir);C(f"Extracted entire disk to '{A.outdir}'")
	finally:D.close()
if __name__=='__main__':v()